# Kernel Hardening Configuration
# This configuration includes basic kernel hardening, self-protection, 
# and attack surface reduction options. These options are expected to 
# have minimal performance impact on most workloads and involve 
# limited legacy API removals.

# Enable reporting of various hardening actions.
CONFIG_BUG=y

# Enforce strict kernel memory permissions.
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_STRICT_MODULE_RWX=y
CONFIG_VMAP_STACK=y

# Enable Address Space Layout Randomization (ASLR) for kernel image and memory.
CONFIG_RANDOMIZE_BASE=y
CONFIG_RANDOMIZE_MEMORY=y

# Randomize allocator freelists and harden metadata.
CONFIG_SLAB_FREELIST_RANDOM=y
CONFIG_SLAB_FREELIST_HARDENED=y
CONFIG_SLAB_BUCKETS=y
CONFIG_SHUFFLE_PAGE_ALLOCATOR=y
CONFIG_RANDOM_KMALLOC_CACHES=y

# Sanity checks for userspace page table mappings.
CONFIG_PAGE_TABLE_CHECK=y
CONFIG_PAGE_TABLE_CHECK_ENFORCED=y

# Randomize kernel stack offset on syscall entry.
CONFIG_RANDOMIZE_KSTACK_OFFSET_DEFAULT=y

# Enable basic stack frame overflow protection.
CONFIG_STACKPROTECTOR=y
CONFIG_STACKPROTECTOR_STRONG=y

# Enable bounds checking for buffer lengths and user copy operations.
CONFIG_HARDENED_USERCOPY=y
CONFIG_FORTIFY_SOURCE=y

# Enable array index bounds checking.
CONFIG_UBSAN=y
CONFIG_UBSAN_TRAP=y
CONFIG_UBSAN_BOUNDS=y

# Sampling-based heap out-of-bounds and use-after-free detection.
CONFIG_KFENCE=y

# Enable linked list integrity checking.
CONFIG_LIST_HARDENED=y

# Initialize heap variables to zero upon allocation.
CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y

# Initialize stack variables to zero at function entry.
CONFIG_INIT_STACK_ALL_ZERO=y

# Wipe RAM at reboot via EFI.
CONFIG_RESET_ATTACK_MITIGATION=y

# Disable DMA between EFI hand-off and kernel's IOMMU setup.
CONFIG_EFI_DISABLE_PCI_DMA=y

# Force IOMMU TLB invalidation to prevent access to stale data.
CONFIG_IOMMU_SUPPORT=y
CONFIG_IOMMU_DEFAULT_DMA_STRICT=y

# Restrict direct physical memory access to non-device memory.
CONFIG_STRICT_DEVMEM=y
CONFIG_IO_STRICT_DEVMEM=y

# Provide seccomp BPF API for syscall attack surface reduction.
CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y

# Enable SYN cookies to mitigate SYN flooding attacks.
CONFIG_SYN_COOKIES=y

# Enable Kernel Control Flow Integrity (requires Clang).
CONFIG_CFI_CLANG=y

# Attack surface reduction: Disable autoloading of TTY line disciplines.
# CONFIG_LDISC_AUTOLOAD is not set

# Dangerous options; consider carefully before enabling:
# CONFIG_COMPAT_BRK is not set   # Disables userspace brk ASLR.
# CONFIG_PROC_KCORE is not set    # Exposes kernel text image layout.
# CONFIG_COMPAT_VDSO is not set    # Disables userspace VDSO ASLR.

# Attack surface reduction: Use modern PTY interface only (devpts).
# CONFIG_LEGACY_PTYS is not set
